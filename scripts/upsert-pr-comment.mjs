import { execFileSync } from "node:child_process";
import fs from "node:fs";
import process from "node:process";

function requireEnv(name) {
  const value = process.env[name];
  if (!value) {
    throw new Error(`Missing required env var: ${name}`);
  }
  return value;
}

function runGh(args, { env } = {}) {
  return execFileSync("gh", args, {
    stdio: ["ignore", "pipe", "pipe"],
    env: {
      ...process.env,
      GH_PAGER: "cat",
      ...env,
    },
  })
    .toString("utf8")
    .trim();
}

function ghApiJson(endpoint, { ghToken, method, fields } = {}) {
  const args = ["api"];
  args.push("-X", method ?? "GET");
  args.push(endpoint);

  for (const [key, value] of Object.entries(fields ?? {})) {
    args.push("-f", `${key}=${value}`);
  }

  const out = runGh(args, { env: { GH_TOKEN: ghToken } });
  try {
    return JSON.parse(out);
  } catch {
    throw new Error(`Failed to parse gh api JSON for ${endpoint}. Output was:\n${out}`);
  }
}

function ghApiAllPages(endpoint, { ghToken, perPage = 100, maxPages = 10 } = {}) {
  const results = [];
  for (let page = 1; page <= maxPages; page += 1) {
    const data = ghApiJson(endpoint, { ghToken, method: "GET", fields: { per_page: perPage, page } });

    if (!Array.isArray(data)) {
      throw new TypeError(`Expected array response from ${endpoint} (page ${page}).`);
    }

    results.push(...data);
    if (data.length < perPage) {
      break;
    }
  }
  return results;
}

const marker = "<!-- vue-pom-generator:release-notes-preview -->";

const repo = requireEnv("GITHUB_REPOSITORY");
const prNumber = Number(requireEnv("PR_NUMBER"));
if (!Number.isFinite(prNumber) || prNumber <= 0) {
  throw new Error(`Invalid PR_NUMBER: ${process.env.PR_NUMBER}`);
}

const ghToken = requireEnv("GH_TOKEN");
const bodyPath = requireEnv("BODY_PATH");

const notes = fs.readFileSync(bodyPath, "utf8").trim();
if (!notes) {
  throw new Error(`Empty release notes in ${bodyPath}`);
}

const body = [
  marker,
  "## Suggested release notes",
  "",
  notes,
  "",
  "_Generated by CI (Copilot)._",
].join("\n");

const comments = ghApiAllPages(`repos/${repo}/issues/${prNumber}/comments`, { ghToken });
const existing = comments.find((c) => typeof c?.body === "string" && c.body.includes(marker));

if (existing?.id) {
  ghApiJson(`repos/${repo}/issues/comments/${existing.id}`, {
    ghToken,
    method: "PATCH",
    fields: { body },
  });
  process.stdout.write(`Updated PR comment ${existing.id}\n`);
} else {
  ghApiJson(`repos/${repo}/issues/${prNumber}/comments`, {
    ghToken,
    method: "POST",
    fields: { body },
  });
  process.stdout.write("Created PR comment\n");
}
